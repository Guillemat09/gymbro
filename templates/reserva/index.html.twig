{# templates/reserva/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Reservas{% endblock %}

{% block body %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h3 m-0">Reservas</h1>

  <div>
    <a href="{{ path('reserva_nueva') }}" class="btn btn-primary">
      <i class="bi bi-plus-lg me-1"></i> Nueva reserva
    </a>
  </div>
</div>

{# BUSCADOR SENCILLO (GET ?q=) #}
<form method="get" class="row g-2 mb-3">
  <div class="col-sm-8 col-md-6">
    <input type="search"
           class="form-control"
           name="q"
           value="{{ q|default('') }}"
           placeholder="Buscar por clase, profesor o alumno"
           autocomplete="off">
  </div>
  <div class="col-auto">
    <button class="btn btn-outline-secondary" type="submit">
      <i class="bi bi-search"></i>
      Buscar
    </button>
  </div>
</form>

{# MENSAJES FLASH #}
{% for label, messages in app.flashes %}
  {% for message in messages %}
    <div class="alert alert-{{ label }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
  {% endfor %}
{% endfor %}

<div class="table-responsive">
  <table class="table table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th>
          {{ knp_pagination_sortable(reservas, 'ID', 'r.id')|raw }}
        </th>

        {# La columna "Alumno" no se muestra a los alumnos #}
        {% set esAlumnoSolo = is_granted('ROLE_ALUMNO') and not is_granted('ROLE_ADMIN') and not is_granted('ROLE_PROFESOR') %}
        {% if not esAlumnoSolo %}
          <th>
            {{ knp_pagination_sortable(reservas, 'Alumno', 'au.nombre')|raw }}
          </th>
        {% endif %}

        <th>
          {{ knp_pagination_sortable(reservas, 'Fecha de reserva', 'r.fecha')|raw }}
        </th>
        <th>
          {{ knp_pagination_sortable(reservas, 'Clase', 'c.nombre')|raw }}
        </th>
        <th>
          {{ knp_pagination_sortable(reservas, 'Fecha de clase', 'c.fecha')|raw }}
        </th>
        <th>
          {{ knp_pagination_sortable(reservas, 'Profesor', 'pu.nombre')|raw }}
        </th>
        <th class="text-center">Opciones</th>
      </tr>
    </thead>

    <tbody>
    {% for reserva in reservas %}
      <tr>
        <td>{{ reserva.id }}</td>

        {% if not esAlumnoSolo %}
          <td>
            {% if reserva.alumno and reserva.alumno.usuario %}
              {{ reserva.alumno.usuario.nombre ?? '' }} {{ reserva.alumno.usuario.apellido1 ?? '' }}{% if reserva.alumno.usuario.apellido2 %} {{ reserva.alumno.usuario.apellido2 }}{% endif %}
            {% else %}
              -
            {% endif %}
          </td>
        {% endif %}

        <td>{{ reserva.fecha ? reserva.fecha|date('d/m/Y') : '-' }}</td>
        <td>{{ reserva.clase ? reserva.clase.nombre : '-' }}</td>
        <td>{{ reserva.clase and reserva.clase.fecha ? reserva.clase.fecha|date('d/m/Y') : '-' }}</td>
        <td>
          {% if reserva.clase and reserva.clase.profesor and reserva.clase.profesor.usuario %}
            {{ reserva.clase.profesor.usuario.nombre ?? '' }} {{ reserva.clase.profesor.usuario.apellido1 ?? '' }}{% if reserva.clase.profesor.usuario.apellido2 %} {{ reserva.clase.profesor.usuario.apellido2 }}{% endif %}
          {% else %}
            -
          {% endif %}
        </td>

        <td class="text-center">
          <a href="{{ path('reserva_visualizar', {'id': reserva.id}) }}"
             class="btn btn-outline-primary btn-sm me-1" title="Ver">
            <i class="bi bi-eye"></i>
          </a>

          {# Para eliminar, form con token CSRF #}
          <form action="{{ path('reserva_eliminar', {'id': reserva.id}) }}"
                method="post" class="d-inline"
                onsubmit="return confirm('Â¿Eliminar esta reserva?');">
            <input type="hidden" name="_token" value="{{ csrf_token('eliminar_reserva_' ~ reserva.id) }}">
            <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar">
              <i class="bi bi-trash"></i>
            </button>
          </form>
        </td>
      </tr>
    {% else %}
      <tr>
        {# colspan: si se oculta la columna de Alumno, la tabla tiene una columna menos #}
        <td colspan="{{ esAlumnoSolo ? 6 : 7 }}" class="text-center text-muted">
          No hay reservas registradas.
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<div class="d-flex justify-content-between align-items-center">
  <div class="small text-muted">
    Mostrando {{ reservas|length }} de {{ reservas.getTotalItemCount }} resultados
  </div>
  <div>
    {{ knp_pagination_render(reservas) }}
  </div>
</div>
{% endblock %}
