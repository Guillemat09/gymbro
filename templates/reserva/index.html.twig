{# templates/reserva/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Reservas{% endblock %}

{% block body %}
<div class="mb-3">
  <h1 class="display-4 m-0">Listado de reservas</h1>
</div>
<div class="text-end mb-3">
  <div class="btn-group">
    <button type="button"
            class="btn btn-primary btn-lg dropdown-toggle"
            data-bs-toggle="dropdown"
            aria-expanded="false"
            style="width: 220px;">
      <i class="bi bi-plus-lg me-1"></i> Nueva reserva
    </button>
    <ul class="dropdown-menu dropdown-menu-end" style="width: 220px;">
      <li>
        <a class="dropdown-item" href="{{ path('reserva_nueva') }}" style="font-size: 1.25rem;">
          <i class="bi bi-ui-checks-grid me-2"></i> Formulario
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="{{ path('reserva_calendario') }}" style="font-size: 1.25rem;">
          <i class="bi bi-calendar3 me-2"></i> Calendario
        </a>
      </li>
    </ul>
  </div>
</div>

{# Persistencia de query para paginación #}
{% set persistedQuery = {} %}
{% for k, v in app.request.query.all %}
    {% if k != 'page' and v is not iterable %}
        {% set persistedQuery = persistedQuery|merge({ (k): v }) %}
    {% endif %}
{% endfor %}
{% set persistedQuery = persistedQuery|merge({'per_page': per_page}) %}

{# BUSCADOR SENCILLO (GET ?q=) #}
{# ===== NUEVA ZONA DE FILTRADO (estilo unificado) ===== #}
<div class="row g-2 align-items-end mb-3">
    <div class="col-12 col-lg-8">
        <form method="get" id="filter-form" class="row g-2">
            <input type="hidden" name="per_page" value="{{ per_page }}">
            <input type="hidden" name="page" value="1">

            {# --- Campo Buscar --- #}
            <div class="col-sm-2 col-md-3">
                <label for="q" class="form-label mb-0">Buscar</label>
                <input type="text"
                       class="form-control"
                       id="q"
                       name="q"
                       value="{{ q }}"
                       placeholder="clase, profesor o alumno">
            </div>

            {# --- Botón Filtrar --- #}
            <div class="col-sm-2 col-md-3 d-flex align-items-end">
                <button class="btn btn-secondary d-flex align-items-center justify-content-center px-2"
                        style="height: 38px; width: 100%;"
                        type="submit">
                    <i class="bi bi-funnel me-1"></i>
                    Filtrar
                </button>
            </div>

            {# --- Botón Quitar Filtrado --- #}
            <div class="col-sm-3 col-md-3 d-flex align-items-end justify-content-end">
                {% if q %}
                <a href="{{ path('app_reserva') }}"
                   class="btn btn-outline-secondary d-flex align-items-center justify-content-center px-2"
                   style="height: 38px; width: 100%;">
                    <i class="bi bi-x-circle me-2"></i>
                    Quitar filtrado
                </a>
                {% endif %}
            </div>
        </form>
    </div>

    {# === Selector per_page === #}
    <div class="col-12 col-lg-4 d-flex align-items-center">
        <form method="get" id="per-page-form" class="d-flex align-items-center ms-auto">
            {% for k, v in app.request.query.all %}
                {% if k not in ['per_page', 'page'] %}
                    {% if v is iterable %}
                        {% for vv in v %}
                            <input type="hidden" name="{{ k }}[]" value="{{ vv }}">
                        {% endfor %}
                    {% else %}
                        <input type="hidden" name="{{ k }}" value="{{ v }}">
                    {% endif %}
                {% endif %}
            {% endfor %}
            <label for="per_page" class="me-2 mb-0 text-nowrap">Mostrar</label>
            <select name="per_page" id="per_page" class="form-select form-select-sm me-2" style="width:auto;">
                {% for opt in [10, 25, 50, 100] %}
                    <option value="{{ opt }}" {% if opt == per_page %}selected{% endif %}>{{ opt }}</option>
                {% endfor %}
            </select>
            <span class="text-muted">/ pág.</span>
        </form>
    </div>
</div>

{# MENSAJES FLASH #}
{% for label, messages in app.flashes %}
  {% for message in messages %}
    <div class="alert alert-{{ label }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
  {% endfor %}
{% endfor %}
{# ====== Ordenación con iconos ====== #}
{% set currentSort = app.request.query.get('sort') %}
{% set currentDir  = app.request.query.get('direction')|default('asc') %}

{% macro sort_icon(field, currentSort, currentDir) %}
    {% if currentSort == field %}
        {% if currentDir == 'desc' %}
            <i class="bi bi-caret-down-fill ms-1"></i>
        {% else %}
            <i class="bi bi-caret-up-fill ms-1"></i>
        {% endif %}
    {% else %}
        <i class="bi bi-arrow-down-up ms-1 opacity-50"></i>
    {% endif %}
{% endmacro %}
{% import _self as self %}

{# Detectar si el usuario es solo alumno (sin ser admin o profesor) #}
{% set esAlumnoSolo =
    is_granted('ROLE_ALUMNO') 
    and not is_granted('ROLE_ADMIN') 
    and not is_granted('ROLE_PROFESOR')
%}


<div class="table-responsive">
  <table class="table table-striped table-bordered">
    <thead class="table-dark">
<tr>
    <th>
        <span class="sortable-header">
            {{ knp_pagination_sortable(reservas, 'ID', 'r.id')|raw }}
        </span>
        {{ self.sort_icon('r.id', currentSort, currentDir) }}
    </th>

    {% if not esAlumnoSolo %}
    <th>
        <span class="sortable-header">
            {{ knp_pagination_sortable(reservas, 'Alumno', 'au.nombre')|raw }}
        </span>
        {{ self.sort_icon('au.nombre', currentSort, currentDir) }}
    </th>
    {% endif %}

    <th>
        <span class="sortable-header">
            {{ knp_pagination_sortable(reservas, 'Fecha de reserva', 'r.fecha')|raw }}
        </span>
        {{ self.sort_icon('r.fecha', currentSort, currentDir) }}
    </th>

    <th>
        <span class="sortable-header">
            {{ knp_pagination_sortable(reservas, 'Clase', 'c.nombre')|raw }}
        </span>
        {{ self.sort_icon('c.nombre', currentSort, currentDir) }}
    </th>

    <th>
        <span class="sortable-header">
            {{ knp_pagination_sortable(reservas, 'Fecha de clase', 'c.fecha')|raw }}
        </span>
        {{ self.sort_icon('c.fecha', currentSort, currentDir) }}
    </th>

    <th>
        <span class="sortable-header">
            {{ knp_pagination_sortable(reservas, 'Profesor', 'pu.nombre')|raw }}
        </span>
        {{ self.sort_icon('pu.nombre', currentSort, currentDir) }}
    </th>

    <th class="text-center">Opciones</th>
</tr>
</thead>

    <tbody>
    {% for reserva in reservas %}
      <tr>
        <td>{{ reserva.id }}</td>
        {% if not esAlumnoSolo %}
          <td>
            {% if reserva.alumno and reserva.alumno.usuario %}
              {{ reserva.alumno.usuario.nombre ?? '' }} {{ reserva.alumno.usuario.apellido1 ?? '' }}{% if reserva.alumno.usuario.apellido2 %} {{ reserva.alumno.usuario.apellido2 }}{% endif %}
            {% else %}
              -
            {% endif %}
          </td>
        {% endif %}
        <td>{{ reserva.fecha ? reserva.fecha|date('d/m/Y') : '-' }}</td>
        <td>{{ reserva.clase ? reserva.clase.nombre : '-' }}</td>
        <td>{{ reserva.clase and reserva.clase.fecha ? reserva.clase.fecha|date('d/m/Y') : '-' }}</td>
        <td>
          {% if reserva.clase and reserva.clase.profesor and reserva.clase.profesor.usuario %}
            {{ reserva.clase.profesor.usuario.nombre ?? '' }} {{ reserva.clase.profesor.usuario.apellido1 ?? '' }}{% if reserva.clase.profesor.usuario.apellido2 %} {{ reserva.clase.profesor.usuario.apellido2 }}{% endif %}
          {% else %}
            -
          {% endif %}
        </td>
        <td class="text-center">
          <a href="{{ path('reserva_visualizar', {'id': reserva.id}) }}"
             class="btn btn-outline-primary btn-sm me-1" title="Ver">
            <i class="bi bi-eye"></i>
          </a>
          <button type="button"
                  class="btn btn-outline-danger btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#modalEliminarReserva{{ reserva.id }}"
                  title="Eliminar">
            <i class="bi bi-trash"></i>
          </button>
          <div class="modal fade" id="modalEliminarReserva{{ reserva.id }}" tabindex="-1" aria-labelledby="modalLabelEliminarReserva{{ reserva.id }}" aria-hidden="true">
              <div class="modal-dialog">
                  <div class="modal-content">
                      <form method="post" action="{{ path('reserva_eliminar', {'id': reserva.id}) }}">
                          <input type="hidden" name="_token" value="{{ csrf_token('eliminar_reserva_' ~ reserva.id) }}">
                          <div class="modal-header">
                              <h5 class="modal-title" id="modalLabelEliminarReserva{{ reserva.id }}">¿Eliminar reserva?</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                          </div>
                          <div class="modal-body">
                              ¿Seguro que quieres eliminar la reserva <strong>ID {{ reserva.id }}</strong>
                              {% if reserva.clase %}
                                  de la clase <strong>{{ reserva.clase.nombre }}</strong>
                              {% endif %}
                              ?
                          </div>
                          <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                              <button type="submit" class="btn btn-danger">Eliminar</button>
                          </div>
                      </form>
                  </div>
              </div>
          </div>
        </td>
      </tr>
    {% else %}
      <tr>
        <td colspan="{{ esAlumnoSolo ? 6 : 7 }}" class="text-center text-muted">
          No hay reservas registradas.
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

{# ====== Resumen + paginación inferior ====== #}
<div class="d-flex justify-content-between align-items-center mt-3">
<div style="color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.7);">
    Mostrando
    {{ ((reservas.currentPageNumber - 1) * reservas.itemNumberPerPage) + 1 }}
    -
    {{ reservas.currentPageNumber * reservas.itemNumberPerPage > reservas.totalItemCount
        ? reservas.totalItemCount
        : reservas.currentPageNumber * reservas.itemNumberPerPage }}
    de {{ reservas.totalItemCount }} reservas
</div>

    <div>
        {% set page = reservas.currentPageNumber %}
        {% set last = reservas.pageCount %}
        {% set start = page - 2 > 0 ? page - 2 : 1 %}
        {% set end = page + 2 <= last ? page + 2 : last %}
        <nav aria-label="Paginación inferior">
            <ul class="pagination pagination-sm mb-0 justify-content-end">
                <li class="page-item {{ page == 1 ? 'disabled' }}">
                    <a class="page-link" href="{{ path(app.request.attributes.get('_route'), persistedQuery|merge({'page': 1})) }}" aria-label="Primera">««</a>
                </li>
                <li class="page-item {{ page == 1 ? 'disabled' }}">
                    <a class="page-link" href="{{ path(app.request.attributes.get('_route'), persistedQuery|merge({'page': page - 1})) }}" aria-label="Anterior">Anterior</a>
                </li>
                {% for i in start..end %}
                    <li class="page-item {{ i == page ? 'active' : '' }}">
                        <a class="page-link" href="{{ i == page ? '#' : path(app.request.attributes.get('_route'), persistedQuery|merge({'page': i})) }}">{{ i }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {{ page == last ? 'disabled' }}">
                    <a class="page-link" href="{{ path(app.request.attributes.get('_route'), persistedQuery|merge({'page': page + 1})) }}" aria-label="Siguiente">Siguiente</a>
                </li>
                <li class="page-item {{ page == last ? 'disabled' }}">
                    <a class="page-link" href="{{ path(app.request.attributes.get('_route'), persistedQuery|merge({'page': last})) }}" aria-label="Última">»»</a>
                </li>
            </ul>
        </nav>
    </div>
</div>
<style>
    thead.table-dark a {
        color: #fff !important;
        text-decoration: none !important;
    }
    thead.table-dark a:hover {
        color: #ccc !important;
        text-decoration: underline;
    }
</style>

<script>
    document.getElementById('per_page')?.addEventListener('change', function() {
        const form = document.getElementById('per-page-form');
        if (!form) return;
        const params = new URLSearchParams(new FormData(form));
        params.delete('page');
        const url = window.location.pathname + '?' + params.toString();
        window.location.href = url;
    });
</script>
{% endblock %}
