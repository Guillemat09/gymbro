{# templates/reserva/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Reservas{% endblock %}

{% block body %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h3 m-0">Reservas</h1>
  <div class="btn-group">
    <button type="button"
            class="btn btn-primary dropdown-toggle"
            data-bs-toggle="dropdown"
            aria-expanded="false">
      <i class="bi bi-plus-lg me-1"></i> Nueva reserva
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
      <li>
        <a class="dropdown-item" href="{{ path('reserva_nueva') }}">
          <i class="bi bi-ui-checks-grid me-2"></i> Formulario
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="{{ path('reserva_calendario') }}">
          <i class="bi bi-calendar3 me-2"></i> Calendario
        </a>
      </li>
    </ul>
  </div>
</div>

{# Persistencia de query para paginación #}
{% set persistedQuery = {} %}
{% for k, v in app.request.query.all %}
    {% if k != 'page' and v is not iterable %}
        {% set persistedQuery = persistedQuery|merge({ (k): v }) %}
    {% endif %}
{% endfor %}
{% set persistedQuery = persistedQuery|merge({'per_page': per_page}) %}

{# BUSCADOR SENCILLO (GET ?q=) #}
<form method="get" class="row g-2 mb-3">
  <input type="hidden" name="per_page" value="{{ per_page }}">
  <input type="hidden" name="page" value="1">
  <div class="col-sm-8 col-md-6">
    <input type="search"
           class="form-control"
           name="q"
           value="{{ q|default('') }}"
           placeholder="Buscar por clase, profesor o alumno"
           autocomplete="off">
  </div>
  <div class="col-auto">
    <button class="btn btn-outline-secondary" type="submit">
      <i class="bi bi-search"></i>
      Buscar
    </button>
  </div>
</form>

<div class="row g-2 align-items-end mb-3">
    <div class="col-12 col-lg-4 d-flex align-items-center ms-auto">
        <form method="get" id="per-page-form" class="d-flex align-items-center ms-auto">
            {% for k, v in app.request.query.all %}
                {% if k not in ['per_page', 'page'] %}
                    {% if v is iterable %}
                        {% for vv in v %}
                            <input type="hidden" name="{{ k }}[]" value="{{ vv }}">
                        {% endfor %}
                    {% else %}
                        <input type="hidden" name="{{ k }}" value="{{ v }}">
                    {% endif %}
                {% endif %}
            {% endfor %}
            <label for="per_page" class="me-2 mb-0 text-nowrap">Mostrar</label>
            <select name="per_page" id="per_page" class="form-select form-select-sm me-2" style="width:auto;">
                {% for opt in [10, 25, 50, 100] %}
                    <option value="{{ opt }}" {% if opt == per_page %}selected{% endif %}>{{ opt }}</option>
                {% endfor %}
            </select>
            <span class="text-muted">/ pág.</span>
        </form>
    </div>
</div>

{# MENSAJES FLASH #}
{% for label, messages in app.flashes %}
  {% for message in messages %}
    <div class="alert alert-{{ label }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
  {% endfor %}
{% endfor %}

<div class="table-responsive">
  <table class="table table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th>
          {{ knp_pagination_sortable(reservas, 'ID', 'r.id')|raw }}
        </th>
        {% set esAlumnoSolo = is_granted('ROLE_ALUMNO') and not is_granted('ROLE_ADMIN') and not is_granted('ROLE_PROFESOR') %}
        {% if not esAlumnoSolo %}
          <th>
            {{ knp_pagination_sortable(reservas, 'Alumno', 'au.nombre')|raw }}
          </th>
        {% endif %}
        <th>
          {{ knp_pagination_sortable(reservas, 'Fecha de reserva', 'r.fecha')|raw }}
        </th>
        <th>
          {{ knp_pagination_sortable(reservas, 'Clase', 'c.nombre')|raw }}
        </th>
        <th>
          {{ knp_pagination_sortable(reservas, 'Fecha de clase', 'c.fecha')|raw }}
        </th>
        <th>
          {{ knp_pagination_sortable(reservas, 'Profesor', 'pu.nombre')|raw }}
        </th>
        <th class="text-center">Opciones</th>
      </tr>
    </thead>
    <tbody>
    {% for reserva in reservas %}
      <tr>
        <td>{{ reserva.id }}</td>
        {% if not esAlumnoSolo %}
          <td>
            {% if reserva.alumno and reserva.alumno.usuario %}
              {{ reserva.alumno.usuario.nombre ?? '' }} {{ reserva.alumno.usuario.apellido1 ?? '' }}{% if reserva.alumno.usuario.apellido2 %} {{ reserva.alumno.usuario.apellido2 }}{% endif %}
            {% else %}
              -
            {% endif %}
          </td>
        {% endif %}
        <td>{{ reserva.fecha ? reserva.fecha|date('d/m/Y') : '-' }}</td>
        <td>{{ reserva.clase ? reserva.clase.nombre : '-' }}</td>
        <td>{{ reserva.clase and reserva.clase.fecha ? reserva.clase.fecha|date('d/m/Y') : '-' }}</td>
        <td>
          {% if reserva.clase and reserva.clase.profesor and reserva.clase.profesor.usuario %}
            {{ reserva.clase.profesor.usuario.nombre ?? '' }} {{ reserva.clase.profesor.usuario.apellido1 ?? '' }}{% if reserva.clase.profesor.usuario.apellido2 %} {{ reserva.clase.profesor.usuario.apellido2 }}{% endif %}
          {% else %}
            -
          {% endif %}
        </td>
        <td class="text-center">
          <a href="{{ path('reserva_visualizar', {'id': reserva.id}) }}"
             class="btn btn-outline-primary btn-sm me-1" title="Ver">
            <i class="bi bi-eye"></i>
          </a>
          <button type="button"
                  class="btn btn-outline-danger btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#modalEliminarReserva{{ reserva.id }}"
                  title="Eliminar">
            <i class="bi bi-trash"></i>
          </button>
          <div class="modal fade" id="modalEliminarReserva{{ reserva.id }}" tabindex="-1" aria-labelledby="modalLabelEliminarReserva{{ reserva.id }}" aria-hidden="true">
              <div class="modal-dialog">
                  <div class="modal-content">
                      <form method="post" action="{{ path('reserva_eliminar', {'id': reserva.id}) }}">
                          <input type="hidden" name="_token" value="{{ csrf_token('eliminar_reserva_' ~ reserva.id) }}">
                          <div class="modal-header">
                              <h5 class="modal-title" id="modalLabelEliminarReserva{{ reserva.id }}">¿Eliminar reserva?</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                          </div>
                          <div class="modal-body">
                              ¿Seguro que quieres eliminar la reserva <strong>ID {{ reserva.id }}</strong>
                              {% if reserva.clase %}
                                  de la clase <strong>{{ reserva.clase.nombre }}</strong>
                              {% endif %}
                              ?
                          </div>
                          <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                              <button type="submit" class="btn btn-danger">Eliminar</button>
                          </div>
                      </form>
                  </div>
              </div>
          </div>
        </td>
      </tr>
    {% else %}
      <tr>
        <td colspan="{{ esAlumnoSolo ? 6 : 7 }}" class="text-center text-muted">
          No hay reservas registradas.
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

{# ====== Resumen + paginación inferior ====== #}
<div class="d-flex justify-content-between align-items-center mt-3">
    <div>
        Mostrando
        {{ ((reservas.currentPageNumber - 1) * reservas.itemNumberPerPage) + 1 }}
        -
        {{ reservas.currentPageNumber * reservas.itemNumberPerPage > reservas.totalItemCount
            ? reservas.totalItemCount
            : reservas.currentPageNumber * reservas.itemNumberPerPage }}
        de {{ reservas.totalItemCount }} reservas
    </div>
    <div>
        {% set page = reservas.currentPageNumber %}
        {% set last = reservas.pageCount %}
        {% set start = page - 2 > 0 ? page - 2 : 1 %}
        {% set end = page + 2 <= last ? page + 2 : last %}
        <nav aria-label="Paginación inferior">
            <ul class="pagination pagination-sm mb-0 justify-content-end">
                <li class="page-item {{ page == 1 ? 'disabled' }}">
                    <a class="page-link" href="{{ path(app.request.attributes.get('_route'), persistedQuery|merge({'page': 1})) }}" aria-label="Primera">««</a>
                </li>
                <li class="page-item {{ page == 1 ? 'disabled' }}">
                    <a class="page-link" href="{{ path(app.request.attributes.get('_route'), persistedQuery|merge({'page': page - 1})) }}" aria-label="Anterior">Anterior</a>
                </li>
                {% for i in start..end %}
                    <li class="page-item {{ i == page ? 'active' : '' }}">
                        <a class="page-link" href="{{ i == page ? '#' : path(app.request.attributes.get('_route'), persistedQuery|merge({'page': i})) }}">{{ i }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {{ page == last ? 'disabled' }}">
                    <a class="page-link" href="{{ path(app.request.attributes.get('_route'), persistedQuery|merge({'page': page + 1})) }}" aria-label="Siguiente">Siguiente</a>
                </li>
                <li class="page-item {{ page == last ? 'disabled' }}">
                    <a class="page-link" href="{{ path(app.request.attributes.get('_route'), persistedQuery|merge({'page': last})) }}" aria-label="Última">»»</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<script>
    document.getElementById('per_page')?.addEventListener('change', function() {
        const form = document.getElementById('per-page-form');
        if (!form) return;
        const params = new URLSearchParams(new FormData(form));
        params.delete('page');
        const url = window.location.pathname + '?' + params.toString();
        window.location.href = url;
    });
</script>
{% endblock %}
