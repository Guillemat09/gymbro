{# filepath: d:\tfg\gymbro\templates\rutina\editar.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}{{ titulo }}{% endblock %}

{% block body %}
    <h1 class="display-5 mb-4">{{ titulo }}</h1>
    <div class="card p-4">
        {{ form_start(form) }}
            {{ form_row(form.alumno) }}
            {{ form_row(form.nombre) }}

            <hr>
            <h5>Ejercicios de la rutina</h5>
            <div id="ejercicios-list">
                {# Mostrar ejercicios actuales #}
                {% for rutinaEjercicio in ejerciciosRutina %}
                    <div class="mb-2 border rounded p-2 bg-light d-flex justify-content-between align-items-center" data-text="{{ rutinaEjercicio.ejercicio.nombre }} - {{ rutinaEjercicio.repeticiones }} repeticiones">
                        <span><strong>{{ loop.index }}.</strong> {{ rutinaEjercicio.ejercicio.nombre }} - {{ rutinaEjercicio.repeticiones }} repeticiones</span>
                        <div>
                            <button type="button" class="btn btn-outline-secondary btn-sm move-up" title="Subir">
                                <i class="bi bi-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm move-down ms-1" title="Bajar">
                                <i class="bi bi-arrow-down"></i>
                            </button>
                            <button type="button" class="btn btn-danger btn-sm ms-2 remove-ejercicio">Eliminar</button>
                        </div>
                        <input type="hidden" name="ejercicios[{{ loop.index0 }}][ejercicio]" value="{{ rutinaEjercicio.ejercicio.id }}">
                        <input type="hidden" name="ejercicios[{{ loop.index0 }}][repeticiones]" value="{{ rutinaEjercicio.repeticiones }}">
                    </div>
                {% endfor %}
            </div>
            <div class="row g-2 align-items-end mb-3" id="add-ejercicio-row">
                <div class="col-md-6">
                    <label for="ejercicio-select" class="form-label">Ejercicio</label>
                    <select id="ejercicio-select" class="form-select">
                        <option value="">Selecciona un ejercicio</option>
                        {% for ejercicio in ejercicios %}
                            <option value="{{ ejercicio.id }}">{{ ejercicio.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="repeticiones-input" class="form-label">Repeticiones</label>
                    <input type="number" id="repeticiones-input" class="form-control" min="1">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-primary" id="add-ejercicio-btn">Añadir</button>
                </div>
            </div>

            {{ form_row(form.guardar) }}
        {{ form_end(form) }}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const addBtn = document.getElementById('add-ejercicio-btn');
            const ejercicioSelect = document.getElementById('ejercicio-select');
            const repeticionesInput = document.getElementById('repeticiones-input');
            const ejerciciosList = document.getElementById('ejercicios-list');

            function actualizarOrden() {
                Array.from(ejerciciosList.children).forEach(function(child, idx) {
                    child.querySelector('span').innerHTML = `<strong>${idx + 1}.</strong> ${child.dataset.text}`;
                    child.querySelector('input[name^="ejercicios"]').name = `ejercicios[${idx}][ejercicio]`;
                    child.querySelectorAll('input')[1].name = `ejercicios[${idx}][repeticiones]`;
                });
            }

            addBtn.addEventListener('click', function() {
                const ejercicioId = ejercicioSelect.value;
                const ejercicioText = ejercicioSelect.options[ejercicioSelect.selectedIndex].text;
                const repeticiones = repeticionesInput.value;

                if (!ejercicioId || !repeticiones || repeticiones < 1) {
                    alert('Selecciona un ejercicio y pon un número de repeticiones válido.');
                    return;
                }

                const div = document.createElement('div');
                div.className = 'mb-2 border rounded p-2 bg-light d-flex justify-content-between align-items-center';
                div.dataset.text = `${ejercicioText} - ${repeticiones} repeticiones`;
                div.innerHTML = `
                    <span><strong></strong> ${div.dataset.text}</span>
                    <div>
                        <button type="button" class="btn btn-outline-secondary btn-sm move-up" title="Subir">
                            <i class="bi bi-arrow-up"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm move-down ms-1" title="Bajar">
                            <i class="bi bi-arrow-down"></i>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm ms-2 remove-ejercicio">Eliminar</button>
                    </div>
                    <input type="hidden" name="ejercicios[][ejercicio]" value="${ejercicioId}">
                    <input type="hidden" name="ejercicios[][repeticiones]" value="${repeticiones}">
                `;
                ejerciciosList.appendChild(div);
                actualizarOrden();

                ejercicioSelect.value = '';
                repeticionesInput.value = '';
            });

            ejerciciosList.addEventListener('click', function(e) {
                const target = e.target;
                const parentDiv = target.closest('div.mb-2');
                if (target.classList.contains('remove-ejercicio')) {
                    parentDiv.remove();
                    actualizarOrden();
                }
                if (target.classList.contains('move-up')) {
                    if (parentDiv.previousElementSibling) {
                        ejerciciosList.insertBefore(parentDiv, parentDiv.previousElementSibling);
                        actualizarOrden();
                    }
                }
                if (target.classList.contains('move-down')) {
                    if (parentDiv.nextElementSibling) {
                        ejerciciosList.insertBefore(parentDiv.nextElementSibling, parentDiv);
                        actualizarOrden();
                    }
                }
            });
        });
    </script>
{% endblock %}