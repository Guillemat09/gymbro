{# filepath: d:\tfg\gymbro\templates\usuario\index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}{{ titulo }}{% endblock %}

{% block body %}
    <h1 class="display-4 mb-3">{{ titulo }}</h1>
    <a href="{{ path('usuario_nuevo') }}" class="btn btn-success mb-3">Nuevo usuario</a>

    {# Controles superiores: selector por página + paginación #}
    <div class="d-flex justify-content-between align-items-center mb-2">
        <form method="get" id="per-page-form" class="d-flex align-items-center">
            <label for="per_page" class="me-2 mb-0">Mostrar</label>
            <select name="per_page" id="per_page" class="form-select form-select-sm me-2" style="width:auto;">
                {% for opt in perPageOptions %}
                    <option value="{{ opt }}" {% if opt == per_page %}selected{% endif %}>{{ opt }}</option>
                {% endfor %}
            </select>
            <span class="text-muted">por página</span>
        </form>

        <div>
            {{ knp_pagination_render(usuarios) }}
        </div>
    </div>

    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Nombre</th>
                <th>Apellidos</th>
                <th>Tipo</th>
                <th>Opciones</th>
            </tr>
        </thead>
        <tbody>
            {% for usuario in usuarios %}
                <tr>
                    <td>{{ usuario.id }}</td>
                    <td>{{ usuario.email }}</td>
                    <td>{{ usuario.nombre }}</td>
                    <td>{{ usuario.apellido1 }}{% if usuario.apellido2 %} {{ usuario.apellido2 }}{% endif %}</td>
                    <td>{{ usuario.tipo|default('-') }}</td>
                    <td class="text-center">
                        <a href="{{ path('usuario_visualizar', {'id': usuario.id}) }}" class="btn btn-outline-primary btn-sm me-1" title="Visualizar">
                            <i class="bi bi-eye"></i>
                        </a>
                        <a href="{{ path('usuario_editar', {'id': usuario.id}) }}" class="btn btn-outline-warning btn-sm me-1" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalEliminarUsuario{{ usuario.id }}" title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </button>

                        <!-- Modal eliminación -->
                        <div class="modal fade" id="modalEliminarUsuario{{ usuario.id }}" tabindex="-1" aria-labelledby="modalLabelUsuario{{ usuario.id }}" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="modalLabelUsuario{{ usuario.id }}">Confirmar eliminación</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                              </div>
                              <div class="modal-body">
                                ¿Eliminar al usuario <strong>{{ usuario.nombre }} {{ usuario.apellido1 }}{% if usuario.apellido2 %} {{ usuario.apellido2 }}{% endif %}</strong> (ID {{ usuario.id }})?
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <form method="post" action="{{ path('usuario_eliminar', {'id': usuario.id}) }}">
                                    <button type="submit" class="btn btn-danger">Eliminar</button>
                                </form>
                              </div>
                            </div>
                          </div>
                        </div>
                    </td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="6" class="text-center">No hay usuarios registrados.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    {# Controles inferiores: paginación y resumen #}
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
        Mostrando {{ ((usuarios.currentPageNumber - 1) * usuarios.itemNumberPerPage) + 1 }} - {{ usuarios.currentPageNumber * usuarios.itemNumberPerPage > usuarios.totalItemCount ? usuarios.totalItemCount : usuarios.currentPageNumber * usuarios.itemNumberPerPage }} de {{ usuarios.totalItemCount }} usuarios
        </div>
        <div>
            {{ knp_pagination_render(usuarios) }}
        </div>
    </div>

    <script>
        // enviar formulario per-page y reiniciar a primera página
        document.getElementById('per_page').addEventListener('change', function() {
            const form = document.getElementById('per-page-form');
            // asegurarse de quitar 'page' para volver a la primera página
            const params = new URLSearchParams(new FormData(form));
            params.delete('page');
            const url = window.location.pathname + '?' + params.toString();
            window.location.href = url;
        });
    </script>
{% endblock %}