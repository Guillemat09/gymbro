{# filepath: d:\tfg\gymbro\templates\clase\editar.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}{{ titulo }}{% endblock %}

{% block body %}
    <h1 class="display-5 mb-4">{{ titulo }}</h1>

    {# Mensajes flash (errores de validación, éxito, etc.) #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label }} mt-2">{{ message|raw }}</div>
        {% endfor %}
    {% endfor %}

    <div class="card p-4">
        {{ form_start(form) }}

            {# Errores de formulario a nivel global #}
            {{ form_errors(form) }}

            {{ form_row(form.nombre) }}
            {{ form_row(form.fecha) }}
            {{ form_row(form.hora) }}
            {{ form_row(form.duracion) }}
            {{ form_row(form.lugar) }}
            {{ form_row(form.limite) }}

            {# ====== PROFESOR (condicionado por rol) ====== #}
            {% if is_granted('ROLE_ADMIN') %}
                {{ form_row(form.profesor) }}
            {% elseif is_granted('ROLE_PROFESOR') %}
                {# Marcamos el campo como renderizado para que no lo pinte Symfony automáticamente #}
                {% do form.profesor.setRendered %}

                <div class="mb-3">
                    <label class="form-label">Profesor</label>
                    <div class="form-control-plaintext">
                        {% if clase.profesor and clase.profesor.usuario %}
                            {{ clase.profesor.usuario.nombre }} {{ clase.profesor.usuario.apellido1 }}
                        {% else %}
                            -
                        {% endif %}
                    </div>
                </div>

                {# Enviamos el ID del profesor como hidden para que pase la validación del EntityType #}
                <input
                    type="hidden"
                    name="{{ form.profesor.vars.full_name }}"
                    value="{{ clase.profesor ? clase.profesor.id : '' }}"
                >
            {% else %}
                {{ form_row(form.profesor) }}
            {% endif %}
            {# ====== FIN PROFESOR ====== #}

            {{ form_row(form.guardar) }}

            {# Al usar render_rest: false, renderizamos manualmente el token CSRF si existe #}
            {% if form._token is defined %}
                {{ form_row(form._token) }}
            {% endif %}

        {{ form_end(form, { render_rest: false }) }}
    </div>
{% endblock %}
